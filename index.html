<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ND-Filter Rechner</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 1rem;
      background:#1e1e1e;
      color:#e0e0e0;
    }
        .container { max-width: 860px; margin:0 auto; padding:0 12px; }
        header { margin-bottom:24px; }
        header h2 { margin:0 0 4px; font-size:clamp(1.6rem,4.5vw,2.2rem); }
        header p { margin:0; color:#b5b5b5; font-size:.95rem; }
    h2 { margin-bottom: 1em; color:#fff; }
    
    .rows { display:grid; gap:18px 20px; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .input-line { display:flex; align-items:stretch; gap:10px; flex:1 1 auto; min-width:240px; }
  .input-line select { flex:1 1 auto; }
  .input-line .lock { margin-left:0; }
    label { width:140px; min-width:140px; margin:0; font-weight:600; letter-spacing:.5px; font-size:.85rem; text-transform:uppercase; color:#cfcfcf; }
    select, button { padding: 12px; border-radius:8px; border:none; font-size:14px; }
    select {
      background:#2c2c2c;
      color:#e0e0e0;
      flex:1;
    }
    button {
      background:#3a3a3a;
      color:#fff;
      cursor:pointer;
      transition:background .2s, transform .15s;
      min-height:46px;
      font-weight:600;
    }
    button:hover { background:#555; }
    button:active { transform:translateY(1px); }
    button:focus-visible { outline:2px solid #7fb346; outline-offset:2px; }
    .lock {
      cursor:pointer;
      padding:5px 10px;
      margin-left:8px;
      border-radius:6px;
      flex:0 0 auto;
      width:92px; /* fixed width to avoid layout shift */
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
      white-space:nowrap;
    }
    .lock.locked {
      background:#4A573E;
      color:#fff;
      border-color:#4A573E;
    }
    .lock:focus-visible { outline:2px solid #9dd35a; outline-offset:2px; }
    .result {
      margin-top:25px;
      padding:15px;
      background:#2c2c2c;
      border-radius:10px;
      color:#fff;
    }
    ul { margin:0; padding-left:20px; }
    li { margin-bottom:4px; }

    /* Mobile Styles */
    @media (max-width:760px){
      .rows { gap:16px 14px; }
      label { width:120px; min-width:120px; }
    }
    @media (max-width:560px){
      .rows { gap:22px; }
      .row { flex-direction:column; align-items:stretch; gap:10px; }
      label { width:100%; min-width:0; }
      .row > select, .row > button { width:100%; margin-left:0; }
      .input-line { flex-direction:row; width:100%; }
      .input-line select { flex:1 1 auto; }
  /* keep fixed width also on mobile */
  .input-line .lock { flex:0 0 auto; }
      button { min-height:50px; }
    }
    /* Visual style when logically locked (not actually disabled so user can still inspect/change) */
    .locked-select {
      position:relative;
      background:#252525 !important;
      color:#9d9d9d !important;
      outline:1px solid #444;
    }
    .locked-select:after { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>ND-Filter Rechner</h2>
      <p>Berechne schnell den benötigten ND-Filter für die Szene.</p>
    </header>
  
  <div class="rows">
  <div class="row">
    <label>ISO:</label>
    <select id="iso">
      <option value="200">200</option>
      <option value="400">400</option>
      <option value="800">800</option>
    </select>
  </div>

  <div class="row">
    <label>Verschluss:</label>
    <div class="input-line">
      <select id="shutter"></select>
      <button class="lock" id="lock-shutter" data-target="shutter">Sperren</button>
    </div>
  </div>

  <div class="row">
    <label>Blende:</label>
    <div class="input-line">
      <select id="aperture"></select>
      <button class="lock" id="lock-aperture" data-target="aperture">Sperren</button>
    </div>
  </div>

  <div class="row">
    <label>Licht (EV100):</label>
    <select id="ev">
      <option value="16">Sehr hell (Schnee/Meer)</option>
      <option value="15">Sonnig</option>
      <option value="14">Leicht bewölkt</option>
      <option value="13">Schatten/Hell bewölkt</option>
      <option value="12">Bewölkt</option>
      <option value="10">Stark bewölkt/Regen</option>
      <option value="8">Sonnenuntergang</option>
      <option value="4">Dämmerung</option>
    </select>
  </div>

  <button onclick="calculate()">Berechnen</button>
  </div>

  <div class="result" id="result"></div>
  </div>

<script>
const shutterOptions = ["1/1000","1/500","1/250","1/125","1/60","1/30","1/15","1/8","1/4","1/2","1"];
const apertureOptions = [1.7,2,2.8,4,5.6,8,11,16,22];
const ndMap = {1:"ND2",2:"ND4",3:"ND8",4:"ND16",5:"ND32",6:"ND64",7:"ND128",8:"ND256",9:"ND512",10:"ND1024"};

function fillSelects(){
  const shutterSel=document.getElementById('shutter');
  shutterOptions.forEach(s=>{
    let opt=document.createElement('option');
    opt.value=s; opt.text=s; shutterSel.appendChild(opt);
  });
  const apertureSel=document.getElementById('aperture');
  apertureOptions.forEach(a=>{
    let opt=document.createElement('option');
    opt.value=a; opt.text="f/"+a; apertureSel.appendChild(opt);
  });
}

fillSelects();

document.querySelectorAll('.lock').forEach(btn=>{
  btn.addEventListener('click',()=>{
    btn.classList.toggle('locked');
    if(btn.classList.contains('locked')){
      btn.textContent = 'Gesperrt';
    } else {
      btn.textContent = 'Sperren';
    }
    const targetId = btn.getAttribute('data-target');
    if(targetId){
      const sel = document.getElementById(targetId);
      if(sel){
        if(btn.classList.contains('locked')){
          sel.classList.add('locked-select');
        } else {
          sel.classList.remove('locked-select');
        }
      }
    }
  });
});

// Auto-calc when ISO changes (unless both shutter & aperture locked result still shown)
document.getElementById('iso').addEventListener('change',()=>{
  calculate();
});

function shutterToSec(s){
  if(s.includes('/')){ let parts=s.split('/'); return parseFloat(parts[0])/parseFloat(parts[1]); }
  return parseFloat(s);
}

function secToShutter(sec){
  for (let s of shutterOptions){
    if(Math.abs(shutterToSec(s)-sec) < 0.0001) return s;
  }
  return null;
}

function evFromSettings(N,t){
  return Math.log2((N*N)/t);
}

function roundStops(stops){
  return Math.max(0, Math.round(stops));
}

function ndLabel(stops){
  return ndMap[stops] || "ND"+Math.pow(2,stops);
}

function calculate(){
  const iso=parseInt(document.getElementById('iso').value);
  let shutter=shutterToSec(document.getElementById('shutter').value);
  let aperture=parseFloat(document.getElementById('aperture').value);
  const ev100=parseInt(document.getElementById('ev').value);

  const evScene=ev100+Math.log2(iso/100);

  const lockedShutter=document.getElementById('lock-shutter').classList.contains('locked');
  const lockedAperture=document.getElementById('lock-aperture').classList.contains('locked');

  let html="<h3>Ergebnis</h3>";

  if(lockedShutter && lockedAperture){
    let evSet=evFromSettings(aperture,shutter);
    let diff=evScene-evSet;
    let stops=roundStops(diff);
    html += `<p>Benötigter ND: ${stops>0?ndLabel(stops):"kein ND nötig"}</p>`;
  } else if(lockedShutter && !lockedAperture){
    // Solve for aperture N = sqrt(t * 2^{EVscene})
    let neededAperture = Math.sqrt(shutter * Math.pow(2, evScene));
    // Choose nearest from list
    let nearest = apertureOptions.reduce((prev,curr)=>Math.abs(curr-neededAperture)<Math.abs(prev-neededAperture)?curr:prev);
    document.getElementById('aperture').value = nearest;
    aperture = nearest;
    let evSet=evFromSettings(aperture,shutter);
    let diff=evScene-evSet; // positive diff => need ND
    let stops=roundStops(diff);
    html += `<p>Empfohlene Blende: f/${aperture} (${stops>0?ndLabel(stops):'kein ND nötig'})</p>`;
  } else if(!lockedShutter && lockedAperture){
    // Solve for shutter t = (N^2)/2^{EVscene}
    let neededShutter = (aperture*aperture)/Math.pow(2, evScene);
    // Find nearest shutter speed
    let nearest = shutterOptions.reduce((prev,curr)=>{
      return Math.abs(shutterToSec(curr)-neededShutter) < Math.abs(shutterToSec(prev)-neededShutter) ? curr : prev;
    });
    document.getElementById('shutter').value = nearest;
    shutter = shutterToSec(nearest);
    let evSet=evFromSettings(aperture,shutter);
    let diff=evScene-evSet;
    let stops=roundStops(diff);
    html += `<p>Empfohlene Verschlusszeit: ${nearest} (${stops>0?ndLabel(stops):'kein ND nötig'})</p>`;
  } else {
    let evSet=evFromSettings(aperture,shutter);
    let diff=evScene-evSet;
    let stops=roundStops(diff);
    html += `<p>Berechnung basierend auf aktuellen Einstellungen.<br>Benötigter ND: ${stops>0?ndLabel(stops):"kein ND nötig"}</p>`;
  }

  document.getElementById('result').innerHTML=html;
}
</script>
</body>
</html>
